---
import LoadingComponent from "@components/Loading.astro";
import Layout from "@layouts/Layout.astro";
---

<!-- Layout title="Loading page..." noHeader="true">
    <LoadingComponent />
</Layout-->
<script>
    import { EventHandler } from "@utils/events";
import { createBareMuxConn, createProxyScripts, SW } from "@utils/serviceWorker";
    import { navigate } from "astro:transitions/client";
    function isComingFromIframe() {
        try {
            return window.self !== window.top;
        }
        catch (e) {
            return true;
        }
    }

    const eHandle = new EventHandler({
        events: {
            "astro:page-load": (() => {
                const isIframe = isComingFromIframe();
                if (!isIframe) {
                    console.log("Assuming request isn't coming from iframe. Redirecting...");
                    //navigate("/");
                }
            }),
            "DOMContentLoaded": (async () => {
                for (let item of createProxyScripts()) {
                        document.body.appendChild(item);
                }
                const checkScript = setInterval(async () => {
                    if (typeof __uv$config !== "undefined" && typeof ScramjetController !== "undefined") {
                        clearInterval(checkScript);
                        const conn = await createBareMuxConn("/baremux/worker.js");
                        window.sw = new SW(conn);
                    }
                }, 100); 
            })
        },
        logging: false
    });
    //Handle the events.
    eHandle.handleEvents(); 
</script>
